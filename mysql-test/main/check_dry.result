create procedure show_corrupted()
begin
select t2.name as tbl, t1.name as idx, t1.type & 16 > 0 as corrupted
from information_schema.innodb_sys_indexes t1
join information_schema.innodb_sys_tables t2
on t1.table_id = t2.table_id
where t2.name like 'test/%' and t1.type & 16
order by t2.name, t1.name;
end~~
# CHECK TABLE .. DRY/RESURRECT (corruption imitation at CHECK TABLE level)
create table t1(a int auto_increment primary key,
b char(100), c int, z int,
index idx1(b))
engine=innodb stats_persistent=0;
insert into t1 values(0,'x',1, 1);
create unique index idx2 on t1(c, b);
create unique index idx3 on t1(z, b);
create table t2 like t1;
insert into t2 values(10,'y',11, 11);
set debug_dbug= '+d,dict_set_index_corrupted';
check table t1;
Table	Op	Msg_type	Msg_text
test.t1	check	Warning	InnoDB: Index idx1 is corrupted
test.t1	check	Warning	InnoDB: Index idx2 is corrupted
test.t1	check	Warning	InnoDB: Index idx3 is corrupted
test.t1	check	error	Corrupt
select c from t1;
ERROR HY000: Index t1 is corrupted
select z from t1;
ERROR HY000: Index t1 is corrupted
call show_corrupted;
tbl	idx	corrupted
test/t1	idx1	1
test/t1	idx2	1
test/t1	idx3	1
check table t1 resurrect;
Table	Op	Msg_type	Msg_text
test.t1	check	Warning	InnoDB: Index idx1 was marked as uncorrupted
test.t1	check	Warning	InnoDB: Index idx2 was marked as uncorrupted
test.t1	check	Warning	InnoDB: Index idx3 was marked as uncorrupted
test.t1	check	status	OK
call show_corrupted;
tbl	idx	corrupted
select c from t1;
c
1
select z from t1;
z
1
check table t2 dry;
Table	Op	Msg_type	Msg_text
test.t2	check	status	OK
select c from t2;
c
11
select z from t2;
z
11
drop tables t1, t2;
# mysqlcheck and real corruption
set debug_dbug= '+d,page_create_corrupted';
create table t1(a int auto_increment primary key,
b char(100), c int, z int,
index idx1(b))
engine=innodb stats_persistent=0;
check table t1 dry;
Table	Op	Msg_type	Msg_text
test.t1	check	Warning	InnoDB: The B-tree of index PRIMARY is corrupted.
test.t1	check	Warning	InnoDB: The B-tree of index idx1 is corrupted.
test.t1	check	error	Corrupt
Processing databases
test
CHECK TABLE `t1`  DRY
test.t1
Warning  : InnoDB: The B-tree of index PRIMARY is corrupted.
Warning  : InnoDB: The B-tree of index idx1 is corrupted.
error    : Corrupt
Processing databases
test
CHECK TABLE `t1`  DRY
test.t1
Warning  : InnoDB: The B-tree of index PRIMARY is corrupted.
Warning  : InnoDB: The B-tree of index idx1 is corrupted.
error    : Corrupt
Processing databases
test
CHECK TABLE `t1`  DRY
test.t1
Warning  : InnoDB: The B-tree of index PRIMARY is corrupted.
Warning  : InnoDB: The B-tree of index idx1 is corrupted.
error    : Corrupt
call show_corrupted;
tbl	idx	corrupted
check table t1;
Table	Op	Msg_type	Msg_text
test.t1	check	Warning	InnoDB: The B-tree of index PRIMARY is corrupted.
test.t1	check	Warning	InnoDB: Index PRIMARY was marked as corrupted
test.t1	check	Warning	InnoDB: Index idx1 is corrupted
test.t1	check	error	Corrupt
call show_corrupted;
tbl	idx	corrupted
test/t1	idx1	1
test/t1	PRIMARY	1
select c from t1;
ERROR HY000: Table 't1' is marked as crashed and should be repaired
Processing databases
test
CHECK TABLE `t1`  RESURRECT
test.t1
Warning  : InnoDB: Index PRIMARY was marked as uncorrupted
Warning  : InnoDB: Table t1 was marked as uncorrupted
Warning  : InnoDB: Index idx1 was marked as uncorrupted
status   : OK
call show_corrupted;
tbl	idx	corrupted
Processing databases
test
CHECK TABLE `t1`  RESURRECT
test.t1                                            OK
drop tables t1;
# SQL compatibility
create table dry(resurrect int);
create table resurrect(dry int);
set @dry= 1;
set @resurrect= 'a';
drop tables dry, resurrect;
create procedure dry(resurrect int) set @a= resurrect;
drop procedure dry;
prepare dry from "set @resurrect= 1";
drop prepare dry;
create function dry(p1 int)
returns int
not deterministic
begin
dry: loop
set p1 = p1 + 1;
if p1 < 10 then iterate dry; end if;
leave dry;
end loop dry;
return 1;
end$
Warnings:
Note	1585	This function 'dry' has the same name as a native function
create or replace function resurrect(p1 int)
returns int
deterministic
begin
resurrect: loop
set p1 = p1 + 1;
if p1 < 10 then iterate resurrect; end if;
leave resurrect;
end loop resurrect;
return 2;
end$
Warnings:
Note	1585	This function 'resurrect' has the same name as a native function
drop function dry;
drop function resurrect;
drop procedure show_corrupted;
