SET time_zone='+04:00';
CREATE TABLE t1 AS SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' AS c1;
ERROR HY000: Illegal parameter data type timestamp with time zone for operation 'CREATE TABLE'
#
# ORDER BY
#
CREATE TABLE t1 (a datetime);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:01');
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1;
a1
2001-01-01 00:00:00 +00:00
2001-01-01 00:00:01 +00:00
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1 DESC;
a1
2001-01-01 00:00:01 +00:00
2001-01-01 00:00:00 +00:00
ANALYZE FORMAT=JSON
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1;
ANALYZE
{
  "query_optimization": {
    "r_total_time_ms": "REPLACED"
  },
  "query_block": {
    "select_id": 1,
    "cost": "REPLACED",
    "r_loops": 1,
    "r_total_time_ms": "REPLACED",
    "nested_loop": [
      {
        "read_sorted_file": {
          "r_rows": 2,
          "filesort": {
            "sort_key": "timestamp_tz(t1.a,'+00:00')",
            "r_loops": 1,
            "r_total_time_ms": "REPLACED",
            "r_used_priority_queue": false,
            "r_output_rows": 2,
            "r_buffer_size": "REPLACED",
            "r_sort_mode": "sort_key,addon_fields",
            "table": {
              "table_name": "t1",
              "access_type": "ALL",
              "loops": 1,
              "r_loops": 1,
              "rows": 2,
              "r_rows": 2,
              "cost": "REPLACED",
              "r_table_time_ms": "REPLACED",
              "r_other_time_ms": "REPLACED",
              "r_engine_stats": REPLACED,
              "filtered": 100,
              "r_total_filtered": 100,
              "r_filtered": 100
            }
          }
        }
      }
    ]
  }
}
DROP TABLE t1;
CREATE TABLE t1 (a datetime, b text character set utf8);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00',''),('2001-01-01 00:00:01','');
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1, b;
a1
2001-01-01 00:00:00 +00:00
2001-01-01 00:00:01 +00:00
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1 DESC, b;
a1
2001-01-01 00:00:01 +00:00
2001-01-01 00:00:00 +00:00
ANALYZE FORMAT=JSON
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1, b;
ANALYZE
{
  "query_optimization": {
    "r_total_time_ms": "REPLACED"
  },
  "query_block": {
    "select_id": 1,
    "cost": "REPLACED",
    "r_loops": 1,
    "r_total_time_ms": "REPLACED",
    "nested_loop": [
      {
        "read_sorted_file": {
          "r_rows": 2,
          "filesort": {
            "sort_key": "timestamp_tz(t1.a,'+00:00'), t1.b",
            "r_loops": 1,
            "r_total_time_ms": "REPLACED",
            "r_used_priority_queue": false,
            "r_output_rows": 2,
            "r_buffer_size": "REPLACED",
            "r_sort_mode": "packed_sort_key,rowid",
            "table": {
              "table_name": "t1",
              "access_type": "ALL",
              "loops": 1,
              "r_loops": 1,
              "rows": 2,
              "r_rows": 2,
              "cost": "REPLACED",
              "r_table_time_ms": "REPLACED",
              "r_other_time_ms": "REPLACED",
              "r_engine_stats": REPLACED,
              "filtered": 100,
              "r_total_filtered": 100,
              "r_filtered": 100
            }
          }
        }
      }
    ]
  }
}
DROP TABLE t1;
#
# Comparison
#
SELECT TIMESTAMP_TZ('2001-01-01 06:00:00','+00:00')=
TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00') AS c1;
c1
1
SELECT TIMESTAMP_TZ('2001-01-01 06:00:00','+00:00')<
TIMESTAMP_TZ('2001-01-01 10:00:01','+04:00') AS c1;
c1
1
SELECT TIMESTAMP_TZ('2001-01-01 06:00:01','+00:00')>
TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00') AS c1;
c1
1
SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00')=
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;
c1
1
SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00')<
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;
c1
1
SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00')>
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;
c1
1
CREATE TABLE t1 (a TIMESTAMP);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT * FROM t1 WHERE a=TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00');
ERROR HY000: Illegal parameter data types timestamp and timestamp with time zone for operation '='
DROP TABLE t1;
CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT * FROM t1 WHERE a=TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00');
ERROR HY000: Illegal parameter data types datetime and timestamp with time zone for operation '='
DROP TABLE t1;
#
# BETWEEN
#
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;
c1
1
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;
c1
0
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;
c1
0
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;
c1
0
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;
c1
1
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;
c1
1
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;
c1
0
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;
c1
1
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1'     ,'+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0'     ,'+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.999999','+04:00') AS c1;
c1
1
SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1'     ,'+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.11'    ,'+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.999999','+04:00') AS c1;
c1
0
#
# IN
#
CREATE TABLE t1 (a datetime);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:01');
SELECT
a,
TIMESTAMP_TZ(a, '+00:00') IN (
TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00'),
TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00')) AS c1
FROM t1;
a	c1
2001-01-01 00:00:00	1
2001-01-01 00:00:01	0
SELECT
a,
TIMESTAMP_TZ(a, '+00:00') IN (
TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00'),
TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00')) AS c1
FROM t1;
a	c1
2001-01-01 00:00:00	1
2001-01-01 00:00:01	0
SELECT
a,
ROW(1, TIMESTAMP_TZ(a, '+00:00')) IN (
ROW(1,TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00')),
ROW(1,TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00'))) AS c1
FROM t1;
a	c1
2001-01-01 00:00:00	1
2001-01-01 00:00:01	0
SELECT
a,
ROW(1,TIMESTAMP_TZ(a, '+00:00')) IN (
ROW(1,TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00')),
ROW(1,TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00'))) AS c1
FROM t1;
a	c1
2001-01-01 00:00:00	1
2001-01-01 00:00:01	0
DROP TABLE t1;
#
# Unary operations
#
SELECT ROUND('2001-01-01 10:00:00' AT TIME ZONE '+00:00');
ERROR HY000: Illegal parameter data type timestamp with time zone for operation 'round'
SELECT FLOOR('2001-01-01 10:00:00' AT TIME ZONE '+00:00');
ERROR HY000: Illegal parameter data type timestamp with time zone for operation 'floor'
SELECT CEILING('2001-01-01 10:00:00' AT TIME ZONE '+00:00');
ERROR HY000: Illegal parameter data type timestamp with time zone for operation 'ceiling'
SELECT ABS('2001-01-01 10:00:00' AT TIME ZONE '+00:00');
ERROR HY000: Illegal parameter data type timestamp with time zone for operation 'abs'
SELECT -('2001-01-01 10:00:00' AT TIME ZONE '+00:00');
ERROR HY000: Illegal parameter data type timestamp with time zone for operation '-'
#
# Dyadic operations
#
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' + 1;
ERROR HY000: Illegal parameter data types timestamp with time zone and int for operation '+'
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' - 1;
ERROR HY000: Illegal parameter data types timestamp with time zone and int for operation '-'
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' * 1;
ERROR HY000: Illegal parameter data types timestamp with time zone and int for operation '*'
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' / 1;
ERROR HY000: Illegal parameter data types timestamp with time zone and int for operation '/'
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' MOD 1;
ERROR HY000: Illegal parameter data types timestamp with time zone and int for operation 'MOD'
SELECT 1 + '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
ERROR HY000: Illegal parameter data types int and timestamp with time zone for operation '+'
SELECT 1 - '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
ERROR HY000: Illegal parameter data types int and timestamp with time zone for operation '-'
SELECT 1 * '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
ERROR HY000: Illegal parameter data types int and timestamp with time zone for operation '*'
SELECT 1 / '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
ERROR HY000: Illegal parameter data types int and timestamp with time zone for operation '/'
SELECT 1 MOD '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
ERROR HY000: Illegal parameter data types int and timestamp with time zone for operation 'MOD'
#
# LEAST/GREATEST
#
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', 1);
ERROR HY000: Illegal parameter data types timestamp with time zone and int for operation 'least'
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', 1);
ERROR HY000: Illegal parameter data types timestamp with time zone and int for operation 'greatest'
SELECT GREATEST(1, '2001-01-01 10:00:00' AT TIME ZONE '+00:00');
ERROR HY000: Illegal parameter data types int and timestamp with time zone for operation 'greatest'
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', '');
ERROR HY000: Illegal parameter data types timestamp with time zone and varchar for operation 'least'
SELECT GREATEST('', '2001-01-01 10:00:00' AT TIME ZONE '+00:00');
ERROR HY000: Illegal parameter data types varchar and timestamp with time zone for operation 'greatest'
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
'2001-01-01 10:00:00' AT TIME ZONE '+01:00');
ERROR HY000: Illegal parameter data types `timestamp at time zone '+00:00` and `timestamp at time zone '+01:00` for operation 'least'
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
'2001-01-01 10:00:00' AT TIME ZONE '+01:00');
ERROR HY000: Illegal parameter data types `timestamp at time zone '+00:00` and `timestamp at time zone '+01:00` for operation 'greatest'
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
'2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
c1
2001-01-01 06:00:00 +00:00
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
c1
NULL
SELECT LEAST(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
c1
NULL
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
'2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
c1
2001-01-01 06:00:00 +00:00
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
c1
NULL
SELECT GREATEST(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
c1
NULL
CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:00.999999');
SELECT LEAST(a, TIMESTAMP_TZ(a,'+00:00')) FROM t1;
ERROR HY000: Illegal parameter data types datetime and timestamp with time zone for operation 'least'
SELECT
a,
LEAST(TIMESTAMP_TZ(a,'+04:00'),
TIMESTAMP_TZ('2001-01-01 04:00:00.999000','+04:00')) AS l,
GREATEST(TIMESTAMP_TZ(a,'+04:00'),
TIMESTAMP_TZ('2001-01-01 04:00:00.999000','+04:00')) AS g
FROM t1;
a	2001-01-01 00:00:00.000000
l	2001-01-01 00:00:00.000000 +04:00
g	2001-01-01 04:00:00.999000 +04:00
a	2001-01-01 00:00:00.999999
l	2001-01-01 00:00:00.999999 +04:00
g	2001-01-01 04:00:00.999000 +04:00
DROP TABLE t1;
#
# Store assignment
#
SET time_zone='+04:00';
CREATE TABLE t1 (a INT);
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
ERROR HY000: Cannot cast 'timestamp with time zone' as 'int' in assignment of `test`.`t1`.`a`
DROP TABLE t1;
CREATE TABLE t1 (a DOUBLE);
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
ERROR HY000: Cannot cast 'timestamp with time zone' as 'double' in assignment of `test`.`t1`.`a`
DROP TABLE t1;
CREATE TABLE t1 (a DECIMAL(30,6));
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
ERROR HY000: Cannot cast 'timestamp with time zone' as 'decimal' in assignment of `test`.`t1`.`a`
DROP TABLE t1;
CREATE TABLE t1 (a VARCHAR(32));
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
ERROR HY000: Cannot cast 'timestamp with time zone' as 'varchar' in assignment of `test`.`t1`.`a`
DROP TABLE t1;
CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
CREATE TABLE t2 (a DATETIME);
INSERT INTO t2 VALUES ('2001-01-01 10:00:00');
INSERT INTO t1 SELECT TIMESTAMP_TZ(a,'+00:00') FROM t2;
SELECT * FROM t1;
a
2001-01-01 10:00:00
2001-01-01 10:00:00
DROP TABLE t1,t2;
CREATE TABLE t1 (a TIMESTAMP);
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
CREATE TABLE t2 (a DATETIME);
INSERT INTO t2 VALUES ('2001-01-01 10:00:00');
INSERT INTO t1 SELECT TIMESTAMP_TZ(a,'+00:00') FROM t2;
SELECT * FROM t1;
a
2001-01-01 14:00:00
2001-01-01 14:00:00
DROP TABLE t1, t2;
SET time_zone=DEFAULT;
#
# Hybrid functions
#
SELECT COALESCE('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
c1
2001-01-01 06:00:00 +00:00
SELECT COALESCE(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
c1
2001-01-01 06:00:00 +00:00
SELECT COALESCE('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
'2001-01-01 10:00:00' AT TIME ZONE '+01:00') AS c1;
ERROR HY000: Illegal parameter data types `timestamp at time zone '+00:00` and `timestamp at time zone '+01:00` for operation 'coalesce'
SET time_zone='+04:00';
CREATE TABLE t1 (a TIMESTAMP);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT * FROM t1;
a
2001-01-01 10:00:00
SELECT COALESCE(a, a AT TIME ZONE '+00:00') AS c1, COALESCE(a AT TIME ZONE '+00:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 06:00:00 +00:00	2001-01-01 06:00:00 +00:00
SELECT COALESCE(a, a AT TIME ZONE '+01:00') AS c1, COALESCE(a AT TIME ZONE '+01:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 07:00:00 +01:00	2001-01-01 07:00:00 +01:00
SELECT COALESCE(a, a AT TIME ZONE '+04:00') AS c1, COALESCE(a AT TIME ZONE '+04:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 10:00:00 +04:00	2001-01-01 10:00:00 +04:00
SET time_zone='+01:00';
SELECT * FROM t1;
a
2001-01-01 07:00:00
SELECT COALESCE(a, a AT TIME ZONE '+00:00') AS c1, COALESCE(a AT TIME ZONE '+00:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 06:00:00 +00:00	2001-01-01 06:00:00 +00:00
SELECT COALESCE(a, a AT TIME ZONE '+01:00') AS c1, COALESCE(a AT TIME ZONE '+01:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 07:00:00 +01:00	2001-01-01 07:00:00 +01:00
SELECT COALESCE(a, a AT TIME ZONE '+04:00') AS c1, COALESCE(a AT TIME ZONE '+04:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 10:00:00 +04:00	2001-01-01 10:00:00 +04:00
DROP TABLE t1;
SET time_zone=DEFAULT;
SET time_zone='+04:00';
CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT * FROM t1;
a
2001-01-01 10:00:00
SELECT COALESCE(a, a AT TIME ZONE '+00:00') AS c1, COALESCE(a AT TIME ZONE '+00:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 06:00:00 +00:00	2001-01-01 06:00:00 +00:00
SELECT COALESCE(a, a AT TIME ZONE '+01:00') AS c1, COALESCE(a AT TIME ZONE '+01:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 07:00:00 +01:00	2001-01-01 07:00:00 +01:00
SELECT COALESCE(a, a AT TIME ZONE '+04:00') AS c1, COALESCE(a AT TIME ZONE '+04:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 10:00:00 +04:00	2001-01-01 10:00:00 +04:00
SET time_zone='+01:00';
SELECT * FROM t1;
a
2001-01-01 10:00:00
SELECT COALESCE(a, a AT TIME ZONE '+00:00') AS c1, COALESCE(a AT TIME ZONE '+00:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 09:00:00 +00:00	2001-01-01 09:00:00 +00:00
SELECT COALESCE(a, a AT TIME ZONE '+01:00') AS c1, COALESCE(a AT TIME ZONE '+01:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 10:00:00 +01:00	2001-01-01 10:00:00 +01:00
SELECT COALESCE(a, a AT TIME ZONE '+04:00') AS c1, COALESCE(a AT TIME ZONE '+04:00', a) AS c2 FROM t1;
c1	c2
2001-01-01 13:00:00 +04:00	2001-01-01 13:00:00 +04:00
DROP TABLE t1;
SET time_zone=DEFAULT;
#
# CASE
#
CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 04:00:00'),
('2001-01-01 00:00:00.999999');
SELECT
a,
CASE TIMESTAMP_TZ(a,'+00:00')
WHEN TIMESTAMP_TZ('2001-01-01 04:00:00','+00:00') THEN 1
WHEN TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00') THEN 4
ELSE 0
END AS c1
FROM t1;
a	c1
2001-01-01 00:00:00.000000	4
2001-01-01 04:00:00.000000	1
2001-01-01 00:00:00.999999	0
DROP TABLE t1;
#
# GROUP BY
#
CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');
SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a;
TIMESTAMP_TZ(a,'+00:00')
2001-01-01 00:00:00.000000 +00:00
2001-01-01 00:00:00.999999 +00:00
SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC;
TIMESTAMP_TZ(a,'+00:00')
2001-01-01 00:00:00.999999 +00:00
2001-01-01 00:00:00.000000 +00:00
DROP TABLE t1;
CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');
SELECT TIMESTAMP_TZ(a,'+01:00') FROM t1 GROUP BY a ORDER BY a;
TIMESTAMP_TZ(a,'+01:00')
2001-01-01 00:00:00.000000 +01:00
2001-01-01 00:00:00.999999 +01:00
SELECT TIMESTAMP_TZ(a,'+01:00') FROM t1 GROUP BY a ORDER BY a DESC;
TIMESTAMP_TZ(a,'+01:00')
2001-01-01 00:00:00.999999 +01:00
2001-01-01 00:00:00.000000 +01:00
DROP TABLE t1;
SET time_zone='+04:00';
CREATE OR REPLACE TABLE t1 (a INT, b DATETIME);
INSERT INTO t1 VALUES (1,'2018-06-19 00:00:00');
SELECT NULLIF(TIMESTAMP_TZ(b,'+00:00'), NULL) AS f, MAX(a) FROM t1 GROUP BY f;
f	MAX(a)
2018-06-19 00:00:00 +00:00	1
DROP TABLE t1;
CREATE OR REPLACE TABLE t1 (a INT, b TIMESTAMP);
INSERT INTO t1 VALUES (1,'2018-06-19 00:00:00');
SELECT NULLIF(b AT TIME ZONE '+00:00', NULL) AS f, MAX(a) FROM t1 GROUP BY f;
f	MAX(a)
2018-06-18 20:00:00 +00:00	1
DROP TABLE t1;
SET time_zone=DEFAULT;
#
# MIN and MAX
#
CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');
SELECT MIN(TIMESTAMP_TZ(a, '+00:00')) FROM t1;
MIN(TIMESTAMP_TZ(a, '+00:00'))
2001-01-01 00:00:00.000000 +00:00
SELECT MAX(TIMESTAMP_TZ(a, '+00:00')) FROM t1;
MAX(TIMESTAMP_TZ(a, '+00:00'))
2001-01-01 00:00:00.999999 +00:00
DROP TABLE t1;
#
# Subselect
#
CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');
SELECT 1=(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1);
ERROR HY000: Illegal parameter data types int and timestamp with time zone for operation '='
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00') AS c0,
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;
c0	c1
2001-01-01 00:00:00.999999 +00:00	2001-01-01 00:00:00.000000 +00:00
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')=
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;
c1
0
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')<
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;
c1
0
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')>
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;
c1
1
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00') AS c0,
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;
c0	c1
2001-01-01 00:00:00.999999 +00:00	2001-01-01 00:00:00.999999 +00:00
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')=
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;
c1
1
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')<
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;
c1
0
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')>
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;
c1
0
SELECT (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 ORDER BY a LIMIT 1) <
(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 ORDER BY a DESC LIMIT 1) AS c1;
c1
1
SELECT (SELECT MIN(TIMESTAMP_TZ(a, '+00:00')) FROM t1) <
(SELECT MAX(TIMESTAMP_TZ(a, '+00:00')) FROM t1) AS c1;
c1
1
DROP TABLE t1;
#
# UNION
# 
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' AS c1
UNION
SELECT '2001-01-01 10:00:01' AT TIME ZONE '+01:00';
ERROR HY000: Illegal parameter data types `timestamp at time zone '+00:00` and `timestamp at time zone '+01:00` for operation 'UNION'
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' AS c1
UNION
SELECT '2001-01-01 10:00:01' AT TIME ZONE '+00:00'
UNION
SELECT '2001-01-01 10:00:02' AT TIME ZONE '+00:00';
c1
2001-01-01 06:00:00 +00:00
2001-01-01 06:00:01 +00:00
2001-01-01 06:00:02 +00:00
SET time_zone='+04:00';
CREATE TABLE t1 (a TIMESTAMP);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT a FROM t1;
a
2001-01-01 10:00:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+00:00' FROM t1;
a
2001-01-01 06:00:00 +00:00
2001-01-01 06:00:00 +00:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+01:00' FROM t1;
a
2001-01-01 07:00:00 +01:00
2001-01-01 07:00:00 +01:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+04:00' FROM t1;
a
2001-01-01 10:00:00 +04:00
2001-01-01 10:00:00 +04:00
SET time_zone='+01:00';
SELECT a FROM t1;
a
2001-01-01 07:00:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+00:00' FROM t1;
a
2001-01-01 06:00:00 +00:00
2001-01-01 06:00:00 +00:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+01:00' FROM t1;
a
2001-01-01 07:00:00 +01:00
2001-01-01 07:00:00 +01:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+04:00' FROM t1;
a
2001-01-01 10:00:00 +04:00
2001-01-01 10:00:00 +04:00
DROP TABLE t1;
SET time_zone=DEFAULT;
SET time_zone='+04:00';
CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT a FROM t1;
a
2001-01-01 10:00:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+00:00' FROM t1;
a
2001-01-01 06:00:00 +00:00
2001-01-01 06:00:00 +00:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+01:00' FROM t1;
a
2001-01-01 07:00:00 +01:00
2001-01-01 07:00:00 +01:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+04:00' FROM t1;
a
2001-01-01 10:00:00 +04:00
2001-01-01 10:00:00 +04:00
SET time_zone='+01:00';
SELECT a FROM t1;
a
2001-01-01 10:00:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+00:00' FROM t1;
a
2001-01-01 09:00:00 +00:00
2001-01-01 09:00:00 +00:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+01:00' FROM t1;
a
2001-01-01 10:00:00 +01:00
2001-01-01 10:00:00 +01:00
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+04:00' FROM t1;
a
2001-01-01 13:00:00 +04:00
2001-01-01 13:00:00 +04:00
DROP TABLE t1;
SET time_zone=DEFAULT;
#
# VIEW
#
SET time_zone='+01:00';
CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
CREATE VIEW v1 AS SELECT a, TIMESTAMP_TZ(a,'+04:00') AS a_p0400 FROM t1;
SELECT a, a_p0400 FROM v1;
a	a_p0400
2001-01-01 10:00:00	2001-01-01 10:00:00 +04:00
SELECT unix_timestamp(a), unix_timestamp(a_p0400) FROM v1;
unix_timestamp(a)	unix_timestamp(a_p0400)
978339600	978328800
SELECT
a_p0400,
CAST(a_p0400 AS SIGNED),
CAST(a_p0400 AS DOUBLE),
CAST(a_p0400 AS DECIMAL(14,0)),
CAST(a_p0400 AS CHAR),
CAST(a_p0400 AS DATETIME)
FROM v1;
a_p0400	2001-01-01 10:00:00 +04:00
CAST(a_p0400 AS SIGNED)	20010101100000
CAST(a_p0400 AS DOUBLE)	20010101100000
CAST(a_p0400 AS DECIMAL(14,0))	20010101100000
CAST(a_p0400 AS CHAR)	2001-01-01 10:00:00 +04:00
CAST(a_p0400 AS DATETIME)	2001-01-01 10:00:00
SELECT
a_p0400,
a_p0400 AT TIME ZONE '+04:00' AS b_p0400,
a_p0400 AT TIME ZONE '+05:00' AS b_p0500
FROM v1 GROUP BY a_p0400 LIMIT 1;
a_p0400	b_p0400	b_p0500
2001-01-01 10:00:00 +04:00	2001-01-01 10:00:00 +04:00	2001-01-01 11:00:00 +05:00
CREATE VIEW v2 AS
SELECT
a_p0400,
a_p0400 AT TIME ZONE '+04:00' AS b_p0400,
a_p0400 AT TIME ZONE '+05:00' AS b_p0500
FROM v1 GROUP BY a_p0400 LIMIT 1;
SELECT * FROM v2;
a_p0400	b_p0400	b_p0500
2001-01-01 10:00:00 +04:00	2001-01-01 10:00:00 +04:00	2001-01-01 11:00:00 +05:00
DROP VIEW v2;
DROP VIEW v1;
DROP TABLE t1;
SET time_zone=DEFAULT;
#
# Prepared statements
#
SET time_zone='+04:00';
EXECUTE IMMEDIATE
'SELECT ? AS p'
USING
TIMESTAMP_TZ('2001-01-01 10:20:30', '+04:00');
p
2001-01-01 10:20:30
SET time_zone=DEFAULT;
#
# Prepared statements - bad example.
# This behaviour will change to return the time zone in the output.
# This should be fixed together with MDEV-14271.
#
EXECUTE IMMEDIATE
'SELECT CONCAT(?) AS p'
USING
TIMESTAMP_TZ('2001-01-01 10:20:30', '+04:00');
p
2001-01-01 10:20:30
SET time_zone=DEFAULT;
