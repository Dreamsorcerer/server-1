SET time_zone='+04:00';

# TODO: metadata

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
CREATE TABLE t1 AS SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' AS c1;

--echo #
--echo # ORDER BY
--echo #

# Fixed length sort keys
CREATE TABLE t1 (a datetime);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:01');
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1;
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1 DESC;
--source include/analyze-format.inc
ANALYZE FORMAT=JSON
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1;
DROP TABLE t1;

# Packed sort keys
CREATE TABLE t1 (a datetime, b text character set utf8);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00',''),('2001-01-01 00:00:01','');
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1, b;
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1 DESC, b;
--source include/analyze-format.inc
ANALYZE FORMAT=JSON
SELECT TIMESTAMP_TZ(a,'+00:00') AS a1 FROM t1 ORDER BY a1, b;
DROP TABLE t1;


--echo #
--echo # Comparison
--echo #

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00','+00:00')=
       TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00','+00:00')<
       TIMESTAMP_TZ('2001-01-01 10:00:01','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:01','+00:00')>
       TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00')=
       TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00')<
       TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00')>
       TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;

CREATE TABLE t1 (a TIMESTAMP);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT * FROM t1 WHERE a=TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00');
DROP TABLE t1;

CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT * FROM t1 WHERE a=TIMESTAMP_TZ('2001-01-01 10:00:00','+04:00');
DROP TABLE t1;


--echo #
--echo # BETWEEN
--echo #

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AS c1;


SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.0','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1','+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.1','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1'     ,'+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.0'     ,'+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.999999','+04:00') AS c1;

SELECT
TIMESTAMP_TZ('2001-01-01 06:00:00.1'     ,'+00:00') BETWEEN
TIMESTAMP_TZ('2001-01-01 10:00:00.11'    ,'+04:00') AND
TIMESTAMP_TZ('2001-01-01 10:00:00.999999','+04:00') AS c1;


--echo #
--echo # IN
--echo #

CREATE TABLE t1 (a datetime);
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:01');

SELECT
  a,
  TIMESTAMP_TZ(a, '+00:00') IN (
    TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00'),
    TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00')) AS c1
FROM t1;

SELECT
  a,
  TIMESTAMP_TZ(a, '+00:00') IN (
    TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00'),
    TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00')) AS c1
FROM t1;


SELECT
  a,
  ROW(1, TIMESTAMP_TZ(a, '+00:00')) IN (
    ROW(1,TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00')),
    ROW(1,TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00'))) AS c1
FROM t1;

SELECT
  a,
  ROW(1,TIMESTAMP_TZ(a, '+00:00')) IN (
    ROW(1,TIMESTAMP_TZ('2001-01-01 00:00:00','+04:00')),
    ROW(1,TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00'))) AS c1
FROM t1;

DROP TABLE t1;


--echo #
--echo # Unary operations
--echo #

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT ROUND('2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT FLOOR('2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT CEILING('2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT ABS('2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPE_FOR_OPERATION
SELECT -('2001-01-01 10:00:00' AT TIME ZONE '+00:00');


--echo #
--echo # Dyadic operations
--echo #

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' + 1;
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' - 1;
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' * 1;
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' / 1;
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' MOD 1;

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 + '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 - '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 * '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 / '2001-01-01 10:00:00' AT TIME ZONE '+00:00';
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1 MOD '2001-01-01 10:00:00' AT TIME ZONE '+00:00';



--echo #
--echo # LEAST/GREATEST
--echo #

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', 1);

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', 1);
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT GREATEST(1, '2001-01-01 10:00:00' AT TIME ZONE '+00:00');

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', '');
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT GREATEST('', '2001-01-01 10:00:00' AT TIME ZONE '+00:00');

# Different time zones are not allowed
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
             '2001-01-01 10:00:00' AT TIME ZONE '+01:00');
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
                '2001-01-01 10:00:00' AT TIME ZONE '+01:00');


SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
             '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
SELECT LEAST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
SELECT LEAST(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;

SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
                '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;
SELECT GREATEST('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
SELECT GREATEST(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;


CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES ('2001-01-01 00:00:00'),('2001-01-01 00:00:00.999999');
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT LEAST(a, TIMESTAMP_TZ(a,'+00:00')) FROM t1;
--vertical_results
SELECT
  a,
  LEAST(TIMESTAMP_TZ(a,'+04:00'),
        TIMESTAMP_TZ('2001-01-01 04:00:00.999000','+04:00')) AS l,
  GREATEST(TIMESTAMP_TZ(a,'+04:00'),
        TIMESTAMP_TZ('2001-01-01 04:00:00.999000','+04:00')) AS g
FROM t1;
--horizontal_results
DROP TABLE t1;


--echo #
--echo # Store assignment
--echo #

SET time_zone='+04:00';

CREATE TABLE t1 (a INT);
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
DROP TABLE t1;

CREATE TABLE t1 (a DOUBLE);
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
DROP TABLE t1;

CREATE TABLE t1 (a DECIMAL(30,6));
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
DROP TABLE t1;

# TODO allow this
CREATE TABLE t1 (a VARCHAR(32));
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
DROP TABLE t1;

CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
CREATE TABLE t2 (a DATETIME);
INSERT INTO t2 VALUES ('2001-01-01 10:00:00');
INSERT INTO t1 SELECT TIMESTAMP_TZ(a,'+00:00') FROM t2;
SELECT * FROM t1;
DROP TABLE t1,t2;

CREATE TABLE t1 (a TIMESTAMP);
INSERT INTO t1 SELECT TIMESTAMP_TZ('2001-01-01 10:00:00','+00:00');
CREATE TABLE t2 (a DATETIME);
INSERT INTO t2 VALUES ('2001-01-01 10:00:00');
INSERT INTO t1 SELECT TIMESTAMP_TZ(a,'+00:00') FROM t2;
SELECT * FROM t1;
DROP TABLE t1, t2;

SET time_zone=DEFAULT;


--echo #
--echo # Hybrid functions
--echo #

SELECT COALESCE('2001-01-01 10:00:00' AT TIME ZONE '+00:00', NULL) AS c1;
SELECT COALESCE(NULL, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') AS c1;

# These returns an error
#CREATE TABLE t1 (a TIMESTAMP);
#SELECT COALESCE(a, '2001-01-01 10:00:00' AT TIME ZONE '+00:00') FROM t1;
#SELECT COALESCE('2001-01-01 10:00:00' AT TIME ZONE '+00:00', a) FROM t1;
#DROP TABLE t1;

# Different time zones are not allowed
--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT COALESCE('2001-01-01 10:00:00' AT TIME ZONE '+00:00',
                '2001-01-01 10:00:00' AT TIME ZONE '+01:00') AS c1;


SET time_zone='+04:00';
CREATE TABLE t1 (a TIMESTAMP);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT * FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+00:00') AS c1, COALESCE(a AT TIME ZONE '+00:00', a) AS c2 FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+01:00') AS c1, COALESCE(a AT TIME ZONE '+01:00', a) AS c2 FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+04:00') AS c1, COALESCE(a AT TIME ZONE '+04:00', a) AS c2 FROM t1;
SET time_zone='+01:00';
SELECT * FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+00:00') AS c1, COALESCE(a AT TIME ZONE '+00:00', a) AS c2 FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+01:00') AS c1, COALESCE(a AT TIME ZONE '+01:00', a) AS c2 FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+04:00') AS c1, COALESCE(a AT TIME ZONE '+04:00', a) AS c2 FROM t1;
DROP TABLE t1;
SET time_zone=DEFAULT;

SET time_zone='+04:00';
CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT * FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+00:00') AS c1, COALESCE(a AT TIME ZONE '+00:00', a) AS c2 FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+01:00') AS c1, COALESCE(a AT TIME ZONE '+01:00', a) AS c2 FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+04:00') AS c1, COALESCE(a AT TIME ZONE '+04:00', a) AS c2 FROM t1;
SET time_zone='+01:00';
SELECT * FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+00:00') AS c1, COALESCE(a AT TIME ZONE '+00:00', a) AS c2 FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+01:00') AS c1, COALESCE(a AT TIME ZONE '+01:00', a) AS c2 FROM t1;
SELECT COALESCE(a, a AT TIME ZONE '+04:00') AS c1, COALESCE(a AT TIME ZONE '+04:00', a) AS c2 FROM t1;
DROP TABLE t1;
SET time_zone=DEFAULT;


--echo #
--echo # CASE
--echo #

CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 04:00:00'),
('2001-01-01 00:00:00.999999');
SELECT
  a,
  CASE TIMESTAMP_TZ(a,'+00:00')
    WHEN TIMESTAMP_TZ('2001-01-01 04:00:00','+00:00') THEN 1
    WHEN TIMESTAMP_TZ('2001-01-01 04:00:00','+04:00') THEN 4
    ELSE 0
  END AS c1
FROM t1;
DROP TABLE t1;


--echo #
--echo # GROUP BY
--echo #

CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');
SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a;
SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC;
DROP TABLE t1;

CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');
SELECT TIMESTAMP_TZ(a,'+01:00') FROM t1 GROUP BY a ORDER BY a;
SELECT TIMESTAMP_TZ(a,'+01:00') FROM t1 GROUP BY a ORDER BY a DESC;
DROP TABLE t1;

# Covers Item_copy:

SET time_zone='+04:00';

CREATE OR REPLACE TABLE t1 (a INT, b DATETIME);
INSERT INTO t1 VALUES (1,'2018-06-19 00:00:00');
SELECT NULLIF(TIMESTAMP_TZ(b,'+00:00'), NULL) AS f, MAX(a) FROM t1 GROUP BY f;
DROP TABLE t1;

CREATE OR REPLACE TABLE t1 (a INT, b TIMESTAMP);
INSERT INTO t1 VALUES (1,'2018-06-19 00:00:00');
SELECT NULLIF(b AT TIME ZONE '+00:00', NULL) AS f, MAX(a) FROM t1 GROUP BY f;
DROP TABLE t1;

SET time_zone=DEFAULT;


--echo #
--echo # MIN and MAX
--echo #

CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');
SELECT MIN(TIMESTAMP_TZ(a, '+00:00')) FROM t1;
SELECT MAX(TIMESTAMP_TZ(a, '+00:00')) FROM t1;
DROP TABLE t1;


--echo #
--echo # Subselect
--echo #

CREATE TABLE t1 (a DATETIME(6));
INSERT INTO t1 VALUES
('2001-01-01 00:00:00'),
('2001-01-01 00:00:00.999999');

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT 1=(SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1);


SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00') AS c0,
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')=
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')<
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')>
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a LIMIT 1) AS c1;

SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00') AS c0,
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')=
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')<
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;
SELECT TIMESTAMP_TZ('2001-01-01 00:00:00.999999','+00:00')>
  (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 GROUP BY a ORDER BY a DESC LIMIT 1) AS c1;

SELECT (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 ORDER BY a LIMIT 1) <
       (SELECT TIMESTAMP_TZ(a,'+00:00') FROM t1 ORDER BY a DESC LIMIT 1) AS c1;

SELECT (SELECT MIN(TIMESTAMP_TZ(a, '+00:00')) FROM t1) <
       (SELECT MAX(TIMESTAMP_TZ(a, '+00:00')) FROM t1) AS c1;

DROP TABLE t1;


--echo #
--echo # UNION
--echo # 

--error ER_ILLEGAL_PARAMETER_DATA_TYPES2_FOR_OPERATION
SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' AS c1
UNION
SELECT '2001-01-01 10:00:01' AT TIME ZONE '+01:00';


SELECT '2001-01-01 10:00:00' AT TIME ZONE '+00:00' AS c1
UNION
SELECT '2001-01-01 10:00:01' AT TIME ZONE '+00:00'
UNION
SELECT '2001-01-01 10:00:02' AT TIME ZONE '+00:00';

SET time_zone='+04:00';
CREATE TABLE t1 (a TIMESTAMP);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT a FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+00:00' FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+01:00' FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+04:00' FROM t1;
SET time_zone='+01:00';
SELECT a FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+00:00' FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+01:00' FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+04:00' FROM t1;
DROP TABLE t1;
SET time_zone=DEFAULT;


SET time_zone='+04:00';
CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
SELECT a FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+00:00' FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+01:00' FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+04:00' FROM t1;
SET time_zone='+01:00';
SELECT a FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+00:00' FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+01:00' FROM t1;
SELECT a FROM t1 UNION ALL SELECT a AT TIME ZONE '+04:00' FROM t1;
DROP TABLE t1;
SET time_zone=DEFAULT;


--echo #
--echo # VIEW
--echo #

SET time_zone='+01:00';
CREATE TABLE t1 (a DATETIME);
INSERT INTO t1 VALUES ('2001-01-01 10:00:00');
CREATE VIEW v1 AS SELECT a, TIMESTAMP_TZ(a,'+04:00') AS a_p0400 FROM t1;
SELECT a, a_p0400 FROM v1;
SELECT unix_timestamp(a), unix_timestamp(a_p0400) FROM v1;

--vertical_results
SELECT
  a_p0400,
  CAST(a_p0400 AS SIGNED),
  CAST(a_p0400 AS DOUBLE),
  CAST(a_p0400 AS DECIMAL(14,0)),
  CAST(a_p0400 AS CHAR),
  CAST(a_p0400 AS DATETIME)
FROM v1;
--horizontal_results

SELECT
  a_p0400,
  a_p0400 AT TIME ZONE '+04:00' AS b_p0400,
  a_p0400 AT TIME ZONE '+05:00' AS b_p0500
FROM v1 GROUP BY a_p0400 LIMIT 1;

CREATE VIEW v2 AS
SELECT
  a_p0400,
  a_p0400 AT TIME ZONE '+04:00' AS b_p0400,
  a_p0400 AT TIME ZONE '+05:00' AS b_p0500
FROM v1 GROUP BY a_p0400 LIMIT 1;
SELECT * FROM v2;
DROP VIEW v2;

#CREATE TABLE t2 (a DATETIME, b TIMESTAMP);
#INSERT INTO t2 SELECT a_p0400, a_p0400 FROM v1;
#SELECT * FROM t2;
#DROP TABLE t2;

DROP VIEW v1;
DROP TABLE t1;
SET time_zone=DEFAULT;

--echo #
--echo # Prepared statements
--echo #

SET time_zone='+04:00';
EXECUTE IMMEDIATE
  'SELECT ? AS p'
USING
  TIMESTAMP_TZ('2001-01-01 10:20:30', '+04:00');

#CREATE TABLE t1 (a DATETIME);
#INSERT INTO t1 VALUES ('2001-01-01 10:00:00'), ('2001-01-01 10:00:01');
#EXECUTE IMMEDIATE
#  'SELECT * FROM t1 WHERE TIMESTAMP_TZ(a,''+04:00'')=?'
#USING
#  TIMESTAMP_TZ('2001-01-01 10:00:00', '+04:00');
#DROP TABLE t1;
SET time_zone=DEFAULT;

--echo #
--echo # Prepared statements - bad example.
--echo # This behaviour will change to return the time zone in the output.
--echo # This should be fixed together with MDEV-14271.
--echo #

EXECUTE IMMEDIATE
  'SELECT CONCAT(?) AS p'
USING
  TIMESTAMP_TZ('2001-01-01 10:20:30', '+04:00');

SET time_zone=DEFAULT;
