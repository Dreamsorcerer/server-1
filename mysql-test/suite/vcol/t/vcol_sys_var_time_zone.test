--echo #
--echo # Start of 10.5 tests
--echo #

--echo #
--echo # MDEV-34037 DATETIME <-> TIMESTAMP conversion in a virtual column corrups the table on @@time_zone change
--echo #

--echo # Without indexes the conversion to TIMESTAMP and from TIMESTAMP
--echo # works without errors or wanings

CREATE TABLE t1
(
  a DATETIME,
  v TIMESTAMP GENERATED ALWAYS AS (a)
);
DROP TABLE t1;

CREATE TABLE t1
(
  a TIMESTAMP,
  v DATETIME GENERATED ALWAYS AS (a)
);
DROP TABLE t1;

CREATE TABLE t1
(
  a DECIMAL(32,0),
  v TIMESTAMP GENERATED ALWAYS AS (a)
);
DROP TABLE t1;

CREATE TABLE t1
(
  a TIMESTAMP,
  v DECIMAL(32,0) GENERATED ALWAYS AS (a)
);
DROP TABLE t1;


--echo #
--echo # TIMESTAMP -> not-TIMESTAMP depends on @@time_zone.
--echo #

CREATE TABLE t1
(
  a TIMESTAMP,
  v DATETIME GENERATED ALWAYS AS (a),
  KEY(v)
);
DROP TABLE t1;

CREATE OR REPLACE TABLE t1 (
  a TIMESTAMP,
  v DECIMAL(32,0) GENERATED ALWAYS AS (a),
  KEY(v)
);
DROP TABLE t1;

CREATE OR REPLACE TABLE t1 (
  a TIMESTAMP,
  v VARCHAR(64) GENERATED ALWAYS AS (a),
  KEY(v)
);
DROP TABLE t1;


--echo #
--echo # not-TIMESTAMP -> TIMESTAMP depends on @@time_zone.
--echo #


CREATE OR REPLACE TABLE t1 (
  a DECIMAL(32,0),
  v TIMESTAMP GENERATED ALWAYS AS (a),
  KEY(v)
);
DROP TABLE t1;


CREATE TABLE t1
(
  a DATETIME,
  v TIMESTAMP GENERATED ALWAYS AS (a),
  KEY(v)
);
DROP TABLE t1;


# VARCHAR->TIMESTAMP additionally depends on TIME_ROUND_FRACTIONAL
--error ER_GENERATED_COLUMN_FUNCTION_IS_NOT_ALLOWED
CREATE TABLE t1
(
  a VARCHAR(64),
  v TIMESTAMP GENERATED ALWAYS AS (a),
  KEY(v)
);
SHOW WARNINGS;


CREATE TABLE t1
(
  a VARCHAR(64),
  v TIMESTAMP GENERATED ALWAYS AS (ROUND(a)),
  KEY(v)
);
DROP TABLE t1;


--echo #
--echo # cast(timestamp_expr at time zone 'TZ' as datetime)
--echo # removes the dependency on @@time_zone
--echo # and allows the conversion from TIMESTAMP to DATETIME.
--echo #


SET time_zone='+04:00';
CREATE TABLE t1
(
  a TIMESTAMP,
  vd DATETIME GENERATED ALWAYS AS (cast(a at time zone '+01:00' as datetime)),
  KEY(vd)
);
SHOW CREATE TABLE t1;
INSERT INTO t1 (a) VALUES ('2001-01-01 00:00:00');
--vertical_results
SET time_zone='+08:00';
SELECT * FROM t1;
SET time_zone='+04:00';
SELECT * FROM t1;
SET time_zone='+02:00';
SELECT * FROM t1;
SET time_zone='+01:00';
SELECT * FROM t1;
SET time_zone='+00:00';
SELECT * FROM t1;
SET time_zone='-01:00';
SELECT * FROM t1;
SET time_zone='-02:00';
SELECT * FROM t1;
SET time_zone='-04:00';
SELECT * FROM t1;
SET time_zone='-08:00';
SELECT * FROM t1;
--horizontal_results
DROP TABLE t1;
SET time_zone=DEFAULT;


SET time_zone='+04:00';
CREATE TABLE t1
(
  a TIMESTAMP(6),
  vd DECIMAL(32,6) GENERATED ALWAYS AS (cast(a at time zone '+01:00' as datetime(6))),
  KEY(vd)
);
SHOW CREATE TABLE t1;
INSERT INTO t1 (a) VALUES ('2001-01-01 00:00:00.123456');
--vertical_results
SET time_zone='+08:00';
SELECT * FROM t1;
SET time_zone='+04:00';
SELECT * FROM t1;
SET time_zone='+02:00';
SELECT * FROM t1;
SET time_zone='+01:00';
SELECT * FROM t1;
SET time_zone='+00:00';
SELECT * FROM t1;
SET time_zone='-01:00';
SELECT * FROM t1;
SET time_zone='-02:00';
SELECT * FROM t1;
SET time_zone='-04:00';
SELECT * FROM t1;
SET time_zone='-08:00';
SELECT * FROM t1;
--horizontal_results
DROP TABLE t1;
SET time_zone=DEFAULT;


--echo #
--echo # unix_timestamp(datetime_expr,'TZ') removes the dependency on @@time_zone
--echo # and allows the conversion from DATETIME to TIMESTAMP.
--echo #

SET time_zone='+04:00';
CREATE TABLE t1
(
  a DATETIME,
  v TIMESTAMP GENERATED ALWAYS AS (UNIX_TIMESTAMP(a, '+01:00')),
  u BIGINT GENERATED ALWAYS AS (UNIX_TIMESTAMP(v)),
  KEY(v)
);
SHOW CREATE TABLE t1;
INSERT INTO t1 (a) VALUES ('2001-01-01 00:00:00');
--vertical_results
SET time_zone='+08:00';
SELECT * FROM t1;
SET time_zone='+04:00';
SELECT * FROM t1;
SET time_zone='+02:00';
SELECT * FROM t1;
SET time_zone='+01:00';
SELECT * FROM t1;
SET time_zone='+00:00';
SELECT * FROM t1;
SET time_zone='-01:00';
SELECT * FROM t1;
SET time_zone='-02:00';
SELECT * FROM t1;
SET time_zone='-04:00';
SELECT * FROM t1;
SET time_zone='-08:00';
SELECT * FROM t1;
--horizontal_results
DROP TABLE t1;
SET time_zone=DEFAULT;


SET time_zone='+04:00';
CREATE TABLE t1
(
  a DECIMAL(32,6),
  v TIMESTAMP(6) GENERATED ALWAYS AS (UNIX_TIMESTAMP(CAST(a AS DATETIME(6)), '+01:00')),
  u DECIMAL(32,6) GENERATED ALWAYS AS (UNIX_TIMESTAMP(v)),
  KEY(v)
);
SHOW CREATE TABLE t1;
INSERT INTO t1 (a) VALUES (20010101000000.123456);
--vertical_results
SET time_zone='+08:00';
SELECT * FROM t1;
SET time_zone='+04:00';
SELECT * FROM t1;
SET time_zone='+02:00';
SELECT * FROM t1;
SET time_zone='+01:00';
SELECT * FROM t1;
SET time_zone='+00:00';
SELECT * FROM t1;
SET time_zone='-01:00';
SELECT * FROM t1;
SET time_zone='-02:00';
SELECT * FROM t1;
SET time_zone='-04:00';
SELECT * FROM t1;
SET time_zone='-08:00';
SELECT * FROM t1;
--horizontal_results
DROP TABLE t1;
SET time_zone=DEFAULT;


--echo #
--echo # End of 10.5 tests
--echo #
