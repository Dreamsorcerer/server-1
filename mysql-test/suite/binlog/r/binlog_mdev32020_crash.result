CALL mtr.add_suppression("Found 1 prepared XA transactions");
CREATE TABLE t1(a INT PRIMARY KEY) ENGINE=InnoDB;
XA START 'a';
INSERT INTO t1 VALUES (1);
XA END 'a';
XA PREPARE 'a';
XA COMMIT 'a';
connect con1,localhost,root,,;
XA START 'b';
INSERT INTO t1 VALUES (2);
XA END 'b';
XA PREPARE 'b';
connect con2,localhost,root,,;
XA START 'd';
INSERT INTO t1 VALUES (4);
XA END 'd';
XA PREPARE 'd';
connection default;
FLUSH NO_WRITE_TO_BINLOG BINARY LOGS;
XA START 'c';
INSERT INTO t1 VALUES (3);
XA END 'c';
XA PREPARE 'c';
XA COMMIT 'c';
connection con2;
XA ROLLBACK 'd';
disconnect con1;
disconnect con2;
connection default;
# restart
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000001	#	Gtid	#	#	BEGIN GTID #-#-#
master-bin.000001	#	Query	#	#	use `mtr`; INSERT INTO test_suppressions (pattern) VALUES ( NAME_CONST('pattern',_latin1'Found 1 prepared XA transactions' COLLATE 'latin1_swedish_ci'))
master-bin.000001	#	Query	#	#	COMMIT
master-bin.000001	#	Gtid	#	#	GTID #-#-#
master-bin.000001	#	Query	#	#	use `test`; CREATE TABLE t1(a INT PRIMARY KEY) ENGINE=InnoDB
master-bin.000001	#	Xa_prepared_trx	#	#	XA PREPARED TRX X'61',X'',1
master-bin.000001	#	Gtid	#	#	BEGIN GTID X'61',X'',1 GTID #-#-#
master-bin.000001	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (1)
master-bin.000001	#	Query	#	#	COMMIT
master-bin.000001	#	Xa_prepared_trx	#	#	XA PREPARED TRX X'62',X'',1
master-bin.000001	#	Xa_prepared_trx	#	#	XA PREPARED TRX X'64',X'',1
master-bin.000001	#	Rotate	#	#	master-bin.000002;pos=POS
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000002	#	Xa_prepared_trx	#	#	XA PREPARED TRX X'63',X'',1
master-bin.000002	#	Gtid	#	#	BEGIN GTID X'63',X'',1 GTID #-#-#
master-bin.000002	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (3)
master-bin.000002	#	Query	#	#	COMMIT
master-bin.000002	#	Gtid	#	#	BEGIN GTID X'64',X'',1 GTID #-#-#
master-bin.000002	#	Query	#	#	ROLLBACK
master-bin.000002	#	Stop	#	#	
PURGE BINARY LOGS TO 'master-bin.000003';
*** Must preserver master-bin.000001, as it contains prepared-but-not-committed trx 'b'
show binary logs;
Log_name	File_size
master-bin.000001	#
master-bin.000002	#
master-bin.000003	#
SELECT * FROM t1 ORDER BY a;
a
1
3
XA COMMIT 'b';
SELECT * FROM t1 ORDER BY a;
a
1
2
3
PURGE BINARY LOGS TO 'master-bin.000003';
*** Must preserve only master-bin.000003, as all prepared trx are now committed
show binary logs;
Log_name	File_size
master-bin.000003	#
include/show_binlog_events.inc
Log_name	Pos	Event_type	Server_id	End_log_pos	Info
master-bin.000003	#	Gtid	#	#	BEGIN GTID X'62',X'',1 GTID #-#-#
master-bin.000003	#	Query	#	#	use `test`; INSERT INTO t1 VALUES (2)
master-bin.000003	#	Query	#	#	COMMIT
master-bin.000003	#	Binlog_checkpoint	#	#	master-bin.000003
DROP TABLE t1;
