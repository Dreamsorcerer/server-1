include/rpl_init.inc [topology=1->2->3]
#
# Initialize test data
# Ensure that all slaves has master_last_event_time == NULL
#
connection server_1;
SET STATEMENT sql_log_bin=0 FOR create table t1 (a int) engine=innodb;
connection server_2;
SET STATEMENT sql_log_bin=0 FOR create table t1 (a int) engine=innodb;
connection server_3;
SET STATEMENT sql_log_bin=0 FOR create table t1 (a int) engine=innodb;
connection server_2;
master_time: NULL (should be NULL)
connection server_3;
include/stop_slave.inc
#
# Test simple insert
#
connection server_1;
insert into t1 values (1+sleep(3));
#
# Test that changes are properly applied by server_2 and server_3
#
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
# Show that the server_2 received the insert from master
select * from t1;
a
1
master <> NULL; Should be 1
1
master_time == slave_time ; Should be 1
1
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
# Show that the server_3 received the insert from master
select * from t1;
a
1
master <> NULL; Should be 1
1
master_time == slave_time ; Should be 1
1
include/stop_slave.inc
connection server_1;
#
# Test insert with forced time
#
SET TIMESTAMP=unix_timestamp("2000-01-01");
insert into t1 values (2+sleep(3));
#
# Test that changes are properly applied by server_2 and server_3
#
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
# Show that the server_2 received the insert from master
select * from t1;
a
1
2
master <> NULL; Should be 1
1
master_time == slave_time ; Should be 1
1
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
# Show that the server_3 received the insert from master
select * from t1;
a
1
2
master <> NULL; Should be 1
1
master_time == slave_time ; Should be 1
1
include/stop_slave.inc
connection server_1;
#
# Test multi-transaction
#
begin;
insert into t1 values (3+sleep(3));
insert into t1 values (4+sleep(3));
commit;
#
# Test that changes are properly applied by server_2 and server_3
#
include/save_master_gtid.inc
connection server_2;
include/sync_with_master_gtid.inc
# Show that the server_2 received the insert from master
select * from t1;
a
1
2
3
4
master <> NULL; Should be 1
1
master_time == slave_time ; Should be 1
1
connection server_3;
include/start_slave.inc
include/sync_with_master_gtid.inc
# Show that the server_3 received the insert from master
select * from t1;
a
1
2
3
4
master <> NULL; Should be 1
1
master_time == slave_time ; Should be 1
1
include/stop_slave.inc
connection server_1;
# cleanup
connection server_3;
include/start_slave.inc
connection server_1;
drop table t1;
include/rpl_end.inc
