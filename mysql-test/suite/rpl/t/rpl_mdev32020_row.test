--source include/have_innodb.inc
--source include/have_binlog_format_row.inc
--source include/master-slave.inc

--echo *** Test row-based replication using different index from the master
--connection master

CREATE TABLE t1 (a int, b int, c int,
  INDEX i1(a),
  INDEX i2(b))
  ENGINE=InnoDB;

INSERT INTO t1 VALUES
  (1,1,0), (1,2,0),
  (2,1,0), (2,2,0);
--sync_slave_with_master

--source include/stop_slave.inc
SET @old_timeout= @@GLOBAL.innodb_lock_wait_timeout;
SET @old_retries= @@GLOBAL.slave_transaction_retries;
SET GLOBAL innodb_lock_wait_timeout= 10;
SET GLOBAL slave_transaction_retries= 3;
--source include/start_slave.inc

--connection master
XA START "t1";
UPDATE t1 FORCE INDEX (i2) SET c=c+1 WHERE a=1 AND b=1;
XA END "t1";
XA PREPARE "t1";

--connection master1
XA START "t2";
UPDATE t1 FORCE INDEX (i2) SET c=c+1 WHERE a=1 AND b=2;
XA END "t2";
XA PREPARE "t2";

--connection master
XA COMMIT "t1";

--connection master1
XA COMMIT "t2";

--connection master
SELECT * FROM t1 ORDER BY a,b,c;

--sync_slave_with_master
SELECT * FROM t1 ORDER BY a,b,c;


# Cleanup
--connection master
DROP TABLE t1;

--sync_slave_with_master

SET GLOBAL innodb_lock_wait_timeout= @old_timeout;
SET GLOBAL slave_transaction_retries= @old_retries;

--source include/rpl_end.inc
