--echo #
--echo # MDEV-28854 Spider: Disallow INSERT DELAYED on Spider table
--echo #

--disable_query_log
--disable_result_log
--source ../../t/test_init.inc
--enable_result_log
--enable_query_log

--connection child2_1
CREATE DATABASE auto_test_remote;
USE auto_test_remote;
CREATE TABLE tbl_a (id BIGINT);
INSERT INTO tbl_a VALUES (1), (1), (3), (3), (4), (5);

--connection child2_2
CREATE DATABASE auto_test_remote2;
USE auto_test_remote2;
CREATE TABLE tbl_b ( id BIGINT PRIMARY KEY);
INSERT INTO tbl_b VALUES (1), (2), (3);

--connection master_1
CREATE DATABASE auto_test_local;
USE auto_test_local;
eval CREATE TABLE tbl_a (
    id BIGINT
) $MASTER_1_ENGINE $MASTER_1_CHARSET COMMENT='table "tbl_a", srv "s_2_1"';

eval CREATE TABLE tbl_b (
    id BIGINT PRIMARY KEY
) $MASTER_1_ENGINE $MASTER_1_CHARSET COMMENT='table "tbl_b", srv "s_2_2"';


SET @general_log_backup = @@global.general_log;
SET @log_output_backup = @@global.log_output;

SET @@global.general_log = 0;

TRUNCATE TABLE mysql.general_log;
SET @@global.log_output = "TABLE";
SET GLOBAL spider_general_log= ON;
SET @@global.general_log = 1;

SELECT COUNT(1) FROM tbl_a l INNER JOIN tbl_b le ON l.id = le.id;

SET @@global.general_log = 0;
SET GLOBAL spider_general_log= OFF;
SELECT argument FROM mysql.general_log WHERE argument LIKE '%select%';


--connection master_1
TRUNCATE TABLE mysql.general_log;
SET @@global.general_log = @general_log_backup;
SET @@global.log_output = @log_output_backup;
DROP DATABASE IF EXISTS auto_test_local;
--connection child2_1
DROP DATABASE IF EXISTS auto_test_remote;
--connection child2_2
DROP DATABASE IF EXISTS auto_test_remote2;

--disable_query_log
--disable_result_log
--source ../t/test_deinit.inc
--enable_query_log
--enable_result_log
